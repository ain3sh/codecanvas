#!/bin/bash
set -e

# =============================================================================
# Install Claude Code with MCP support
# =============================================================================

# Timestamped logging helper
log() { echo "[$(date '+%H:%M:%S')] $1"; }
log_start() { echo "[$(date '+%H:%M:%S')] >>> START: $1"; STEP_START=$(date +%s); }
log_done() { 
    local elapsed=$(($(date +%s) - STEP_START))
    echo "[$(date '+%H:%M:%S')] <<< DONE: $1 (${elapsed}s)"
}

log "=== INSTALL SCRIPT STARTED ==="
INSTALL_START=$(date +%s)

log_start "System dependencies (apt-get)"
apt-get update
apt-get install -y --no-install-recommends \
    curl git build-essential libcairo2-dev ca-certificates procps
rm -rf /var/lib/apt/lists/*
log_done "System dependencies"

# =============================================================================
# Install Node.js
# =============================================================================
log_start "Node.js via nvm"
curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.2/install.sh | bash
source "$HOME/.nvm/nvm.sh"
nvm install 22
log_done "Node.js"

# =============================================================================
# Install Claude Code and bash-language-server
# =============================================================================
log_start "Claude Code + bash-language-server (npm)"
{% if claude_version %}
npm install -g @anthropic-ai/claude-code@{{ claude_version }} bash-language-server
{% else %}
npm install -g @anthropic-ai/claude-code@latest bash-language-server
{% endif %}
log_done "Claude Code + bash-language-server"

# =============================================================================
# Install Python and uv for MCP servers
# =============================================================================
log_start "uv (Python package manager)"
curl -LsSf https://astral.sh/uv/install.sh | sh
export PATH="$HOME/.local/bin:$PATH"
log_done "uv"

log_start "Python 3.13"
uv python install 3.13
log_done "Python 3.13"

# =============================================================================
# Install MCP servers from git source
# =============================================================================
{% if mcp_git_source %}
log_start "Git clone MCP: {{ mcp_git_source }}"
cd /tmp

# Clone repo (optional token via env var, without embedding secrets in the script).
if [ -n "${GITHUB_TOKEN:-}" ]; then
    git clone $(echo "{{ mcp_git_source }}" | sed "s|https://github.com|https://x-access-token:${GITHUB_TOKEN}@github.com|") mcp-repo
else
    git clone {{ mcp_git_source }} mcp-repo
fi
cd mcp-repo
log_done "Git clone MCP"

log_start "Python venv + pip install MCP packages"
uv venv /opt/venv --python 3.13
{% if mcp_extras %}
uv pip install --python /opt/venv/bin/python ".[{{ mcp_extras }}]"
{% else %}
uv pip install --python /opt/venv/bin/python "."
{% endif %}
log_done "Python venv + pip install MCP packages"

# Add venv bin to PATH
export PATH="/opt/venv/bin:$PATH"
echo 'export PATH="/opt/venv/bin:$PATH"' >> /etc/profile.d/venv-path.sh

log "Skipping build-time multilspy warmup; CodeCanvas warms at SessionStart"

{% if mcp_extras %}
{% set _extras = (mcp_extras.split(',') | map('trim') | list) %}
{% else %}
{% set _extras = [] %}
{% endif %}

{% if 'codecanvas' in _extras %}
# CodeCanvas custom (non-multilspy) language servers.
# sh: bash-language-server already installed via npm above.
{% if install_r_languageserver %}
# r: requires R base + languageserver package.
if [ -d /app ] && find /app -type f \( -name '*.R' -o -name '*.r' -o -name '*.Rmd' -o -name '*.Rmarkdown' \) -print -quit | grep -q .; then
    log_start "R languageserver (custom LSP)"
    apt-get update
    apt-get install -y --no-install-recommends r-base
    rm -rf /var/lib/apt/lists/*
    R --slave -e "install.packages('languageserver', repos='https://cloud.r-project.org')"
    log_done "R languageserver (custom LSP)"
else
    log "Skipping R languageserver; no R files detected in /app"
fi
{% else %}
log "Skipping R languageserver; disabled by profile config"
{% endif %}
{% else %}
log "CodeCanvas not enabled; skipping R languageserver"
{% endif %}

cd /
rm -rf /tmp/mcp-repo
{% else %}
log "No MCP git source specified, skipping MCP installation"
{% endif %}

INSTALL_ELAPSED=$(($(date +%s) - INSTALL_START))
log "=== INSTALL SCRIPT COMPLETE (${INSTALL_ELAPSED}s total) ==="
log "Versions:"
claude --version 2>/dev/null || log "  Claude Code: installed"
log "  uv: $(uv --version 2>/dev/null || echo 'N/A')"
log "  python: $(python3 --version 2>/dev/null || echo 'N/A')"
