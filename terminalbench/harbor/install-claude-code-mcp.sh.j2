#!/bin/bash
set -e

# =============================================================================
# Install Claude Code with MCP support
# Tier 1: Profile-based skip (only codecanvas needs LSP warmup)
# Tier 2: Language detection (only warmup languages present in /app)
# =============================================================================

# Timestamped logging helper
log() { echo "[$(date '+%H:%M:%S')] $1"; }
log_start() { echo "[$(date '+%H:%M:%S')] >>> START: $1"; STEP_START=$(date +%s); }
log_done() { 
    local elapsed=$(($(date +%s) - STEP_START))
    echo "[$(date '+%H:%M:%S')] <<< DONE: $1 (${elapsed}s)"
}

log "=== INSTALL SCRIPT STARTED ==="
INSTALL_START=$(date +%s)

log_start "System dependencies (apt-get)"
apt-get update
apt-get install -y --no-install-recommends \
    curl git build-essential libcairo2-dev ca-certificates
rm -rf /var/lib/apt/lists/*
log_done "System dependencies"

# =============================================================================
# Install Node.js
# =============================================================================
log_start "Node.js via nvm"
curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.2/install.sh | bash
source "$HOME/.nvm/nvm.sh"
nvm install 22
log_done "Node.js"

# =============================================================================
# Install Claude Code and bash-language-server
# =============================================================================
log_start "Claude Code + bash-language-server (npm)"
{% if claude_version %}
npm install -g @anthropic-ai/claude-code@{{ claude_version }} bash-language-server
{% else %}
npm install -g @anthropic-ai/claude-code@latest bash-language-server
{% endif %}
log_done "Claude Code + bash-language-server"

# =============================================================================
# Install Python and uv for MCP servers
# =============================================================================
log_start "uv (Python package manager)"
curl -LsSf https://astral.sh/uv/install.sh | sh
export PATH="$HOME/.local/bin:$PATH"
log_done "uv"

log_start "Python 3.13"
uv python install 3.13
log_done "Python 3.13"

# =============================================================================
# Install MCP servers from git source
# =============================================================================
{% if mcp_git_source %}
log_start "Git clone MCP: {{ mcp_git_source }}"
cd /tmp

# Clone repo (use token in URL for private repos)
{% if github_token %}
git clone $(echo "{{ mcp_git_source }}" | sed "s|https://github.com|https://x-access-token:{{ github_token }}@github.com|") mcp-repo
{% else %}
git clone {{ mcp_git_source }} mcp-repo
{% endif %}
cd mcp-repo
log_done "Git clone MCP"

log_start "Python venv + pip install MCP packages"
uv venv /opt/venv --python 3.13
uv pip install --python /opt/venv/bin/python ".[codecanvas,locagent]"
log_done "Python venv + pip install MCP packages"

# Add venv bin to PATH
export PATH="/opt/venv/bin:$PATH"
echo 'export PATH="/opt/venv/bin:$PATH"' >> /etc/profile.d/venv-path.sh

{% if needs_codecanvas %}
# =============================================================================
# CodeCanvas LSP warmup: Detect languages in /app, warmup only those
# Derived from codecanvas/parser/config.py MULTILSPY_LANGUAGES
# =============================================================================
log_start "Language detection for LSP warmup"
LANGS=""

# Python
[ -n "$(find /app -name '*.py' -type f 2>/dev/null | head -1)" ] && LANGS="$LANGS python"

# TypeScript/JavaScript (consolidated)
[ -n "$(find /app \( -name '*.ts' -o -name '*.tsx' -o -name '*.js' -o -name '*.jsx' \) -type f 2>/dev/null | head -1)" ] && LANGS="$LANGS typescript"

# Go
[ -n "$(find /app -name '*.go' -type f 2>/dev/null | head -1)" ] && LANGS="$LANGS go"

# Rust
[ -n "$(find /app -name '*.rs' -type f 2>/dev/null | head -1)" ] && LANGS="$LANGS rust"

# Java
[ -n "$(find /app -name '*.java' -type f 2>/dev/null | head -1)" ] && LANGS="$LANGS java"

# Ruby
[ -n "$(find /app -name '*.rb' -type f 2>/dev/null | head -1)" ] && LANGS="$LANGS ruby"

# C/C++ (consolidated under cpp for multilspy)
[ -n "$(find /app \( -name '*.c' -o -name '*.h' -o -name '*.cpp' -o -name '*.cc' -o -name '*.hpp' \) -type f 2>/dev/null | head -1)" ] && LANGS="$LANGS cpp"

# C#
[ -n "$(find /app -name '*.cs' -type f 2>/dev/null | head -1)" ] && LANGS="$LANGS csharp"

# Kotlin
[ -n "$(find /app \( -name '*.kt' -o -name '*.kts' \) -type f 2>/dev/null | head -1)" ] && LANGS="$LANGS kotlin"

# Dart
[ -n "$(find /app -name '*.dart' -type f 2>/dev/null | head -1)" ] && LANGS="$LANGS dart"

log "Detected languages:$LANGS"
log_done "Language detection"

# R languageserver (custom LSP, not multilspy) - only if R files present
if [ -n "$(find /app \( -name '*.R' -o -name '*.r' \) -type f 2>/dev/null | head -1)" ]; then
    log_start "R languageserver install"
    apt-get update
    apt-get install -y --no-install-recommends r-base
    rm -rf /var/lib/apt/lists/*
    R --slave -e "install.packages('languageserver', repos='https://cloud.r-project.org')"
    log_done "R languageserver install"
fi

# Warmup multilspy for detected languages (downloads LSP binaries)
if [ -n "$LANGS" ]; then
    log_start "LSP warmup (multilspy parallel)"
    /opt/venv/bin/python3 -c "
import sys
from datetime import datetime
from multilspy import SyncLanguageServer
from multilspy.multilspy_config import MultilspyConfig
from multilspy.multilspy_logger import MultilspyLogger
from concurrent.futures import ThreadPoolExecutor, as_completed, TimeoutError
import tempfile, os, time

def ts(): return datetime.now().strftime('%H:%M:%S')

EXT_MAP = {
    'python': '.py',
    'typescript': '.ts',
    'go': '.go',
    'rust': '.rs',
    'java': '.java',
    'ruby': '.rb',
    'cpp': '.cpp',
    'csharp': '.cs',
    'kotlin': '.kt',
    'dart': '.dart',
}

TIMEOUT_PER_LANG = 90  # seconds per language

def warmup_lang(lang):
    '''Warmup single language - downloads binary + starts/stops server.'''
    print(f'[{ts()}] Starting warmup: {lang}', flush=True)
    start = time.time()
    logger = MultilspyLogger()
    config = MultilspyConfig.from_dict({'code_language': lang})
    with tempfile.TemporaryDirectory() as td:
        ext = EXT_MAP.get(lang, '.txt')
        dummy = os.path.join(td, f'test{ext}')
        open(dummy, 'w').write('// dummy')
        print(f'[{ts()}] {lang}: Creating LSP server...', flush=True)
        lsp = SyncLanguageServer.create(config, logger, td)
        print(f'[{ts()}] {lang}: Starting server...', flush=True)
        with lsp.start_server():
            pass
        print(f'[{ts()}] {lang}: Server started and stopped OK', flush=True)
    return lang, time.time() - start

langs = '$LANGS'.split()
max_workers = min(4, len(langs))
print(f'[{ts()}] Warming up {len(langs)} language(s) with {max_workers} worker(s), {TIMEOUT_PER_LANG}s timeout each', flush=True)

with ThreadPoolExecutor(max_workers=max_workers) as executor:
    futures = {executor.submit(warmup_lang, lang): lang for lang in langs}
    for future in as_completed(futures, timeout=TIMEOUT_PER_LANG * len(langs)):
        lang = futures[future]
        try:
            _, elapsed = future.result(timeout=TIMEOUT_PER_LANG)
            print(f'[{ts()}] {lang} ready ({elapsed:.1f}s)', flush=True)
        except TimeoutError:
            print(f'[{ts()}] WARNING: {lang} warmup timed out after {TIMEOUT_PER_LANG}s', flush=True)
        except Exception as e:
            print(f'[{ts()}] WARNING: {lang} warmup failed: {e}', flush=True)

print(f'[{ts()}] LSP warmup complete', flush=True)
"
    log_done "LSP warmup"
else
    log "No multilspy languages detected, skipping LSP warmup"
fi
{% else %}
log "CodeCanvas not configured, skipping LSP warmup"
{% endif %}

cd /
rm -rf /tmp/mcp-repo
{% else %}
log "No MCP git source specified, skipping MCP installation"
{% endif %}

INSTALL_ELAPSED=$(($(date +%s) - INSTALL_START))
log "=== INSTALL SCRIPT COMPLETE (${INSTALL_ELAPSED}s total) ==="
log "Versions:"
claude --version 2>/dev/null || log "  Claude Code: installed"
log "  uv: $(uv --version 2>/dev/null || echo 'N/A')"
log "  python: $(python3 --version 2>/dev/null || echo 'N/A')"
