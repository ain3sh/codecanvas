#!/bin/bash
set -e

# =============================================================================
# Install Claude Code with MCP support
# =============================================================================

echo "=== Installing system dependencies ==="
apt-get update
apt-get install -y curl git build-essential libcairo2-dev

# =============================================================================
# Install Node.js and Claude Code
# =============================================================================
echo "=== Installing Node.js via nvm ==="
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.2/install.sh | bash
source "$HOME/.nvm/nvm.sh"
nvm install 22
npm -v

echo "=== Installing Claude Code ==="
{% if claude_version %}
npm install -g @anthropic-ai/claude-code@{{ claude_version }}
{% else %}
npm install -g @anthropic-ai/claude-code@latest
{% endif %}

# =============================================================================
# Install Python and uv for MCP servers
# =============================================================================
echo "=== Installing uv (Python package manager) ==="
curl -LsSf https://astral.sh/uv/install.sh | sh
export PATH="$HOME/.local/bin:$PATH"

echo "=== Setting up Python environment ==="
uv python install 3.13

# =============================================================================
# Install MCP servers from git source
# =============================================================================
{% if mcp_git_source %}
echo "=== Installing MCP servers from git ==="
cd /tmp
{% if github_token %}
# Use authenticated URL for private repos
git clone https://{{ github_token }}@{{ mcp_git_source | replace('https://', '') }} mcp-repo
{% else %}
git clone {{ mcp_git_source }} mcp-repo
{% endif %}
cd mcp-repo

# Install with all MCP extras (locagent, codecanvas, etc.)
uv pip install --system ".[locagent,mcp]"
cd /
rm -rf /tmp/mcp-repo
{% else %}
echo "=== No MCP git source specified, skipping MCP installation ==="
{% endif %}

echo "=== Installation complete ==="
claude --version || echo "Claude Code installed"
uv --version
python3 --version
