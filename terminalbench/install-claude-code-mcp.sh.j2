#!/bin/bash
set -e

# =============================================================================
# Install Claude Code with MCP support (locagent)
# =============================================================================

echo "=== Installing system dependencies ==="
apt-get update
apt-get install -y curl git

# =============================================================================
# Install Node.js and Claude Code
# =============================================================================
echo "=== Installing Node.js via nvm ==="
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.2/install.sh | bash
source "$HOME/.nvm/nvm.sh"
nvm install 22
npm -v

echo "=== Installing Claude Code ==="
{% if claude_version %}
npm install -g @anthropic-ai/claude-code@{{ claude_version }}
{% else %}
npm install -g @anthropic-ai/claude-code@latest
{% endif %}

# =============================================================================
# Install Python and uv for MCP servers
# =============================================================================
echo "=== Installing uv (Python package manager) ==="
curl -LsSf https://astral.sh/uv/install.sh | sh
export PATH="$HOME/.local/bin:$PATH"

echo "=== Setting up Python environment ==="
uv python install 3.13

# =============================================================================
# Install locagent MCP server
# =============================================================================
echo "=== Installing locagent MCP server ==="

{% if locagent_git_url %}
# Install from git repository
cd /tmp
{% if github_token %}
# Use authenticated URL for private repos
git clone https://{{ github_token }}@{{ locagent_git_url | replace('https://', '') }} codecanvas-repo
{% else %}
git clone {{ locagent_git_url }} codecanvas-repo
{% endif %}
cd codecanvas-repo
{% if locagent_git_ref %}
git checkout {{ locagent_git_ref }}
{% endif %}

# Install locagent with dependencies using uv (non-editable, as we delete source after)
uv pip install --system ".[locagent]"
cd /
rm -rf /tmp/codecanvas-repo

{% elif locagent_pip_package %}
# Install from PyPI or pip-compatible source
uv pip install --system {{ locagent_pip_package }}

{% else %}
# Install locagent dependencies only (code will be mounted/provided separately)
uv pip install --system \
    "mcp>=1.0.0" \
    "networkx>=3.0.0" \
    "tree-sitter>=0.24.0" \
    "tree-sitter-language-pack>=0.13.0" \
    "bm25s>=0.2.0" \
    "libcst>=1.0.0" \
    "pydantic>=2.0.0" \
    "click>=8.0.0" \
    "python-dotenv>=1.0.0" \
    "PyYAML>=6.0.0" \
    "tqdm>=4.60.0" \
    "llama-index-core>=0.11.0" \
    "llama-index-readers-file>=0.4.0" \
    "llama-index-retrievers-bm25>=0.4.0" \
    "rapidfuzz>=3.0.0" \
    "PyStemmer>=2.0.0"
{% endif %}

echo "=== Installation complete ==="
claude --version || echo "Claude Code installed"
uv --version
python3 --version
